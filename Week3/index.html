<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library App</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    button { padding: 5px 10px; cursor: pointer; }
    .borrowed { color: red; font-weight: bold; }
    .available { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ðŸ“š Library Books</h1>
  <button onclick="loadBooks()">ðŸ”„ Refresh</button>
  <table id="books-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Title</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_BASE = "http://localhost:3000";
    let currentEtag = null;

    async function loadBooks() {
      try {
        const headers = {};
        if (currentEtag) {
          headers["If-None-Match"] = currentEtag;
        }

        const res = await fetch(`${API_BASE}/books`, { headers });

        if (res.status === 304) {
          console.log("Not modified. Using cached data.");
          return; // dá»¯ liá»‡u cÅ© giá»¯ nguyÃªn
        }

        currentEtag = res.headers.get("ETag");
        const data = await res.json();
        renderBooks(data.books);
      } catch (err) {
        console.error("Error loading books:", err);
      }
    }

    function renderBooks(books) {
      const tbody = document.querySelector("#books-table tbody");
      tbody.innerHTML = "";
      books.forEach((book) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${book.id}</td>
          <td>${book.title}</td>
          <td class="${book.status}">${book.status}</td>
          <td>
            ${
              book.status === "available"
                ? `<button onclick="borrowBook(${book.id})">Borrow</button>`
                : "â€”"
            }
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    async function borrowBook(id) {
      try {
        const res = await fetch(`${API_BASE}/books/${id}/borrow`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });
        if (!res.ok) {
          const err = await res.json();
          alert("Error: " + err.error);
          return;
        }
        const result = await res.json();
        alert(`You borrowed: ${result.book.title}`);
        loadBooks(); // reload danh sÃ¡ch
      } catch (err) {
        console.error("Error borrowing:", err);
      }
    }

    // Load ngay khi má»Ÿ trang
    loadBooks();
  </script>
</body>
</html>
